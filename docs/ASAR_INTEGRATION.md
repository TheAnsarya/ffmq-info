# Asar Assembler Integration

Complete guide to integrating rebuilt graphics into the ROM build process using asar.

## Overview

The asar integration system automatically generates assembly include files that insert rebuilt graphics at the correct ROM addresses during the build process.

```
Edit PNG â†’ Rebuild â†’ Generate ASM â†’ Build ROM â†’ Modified ROM with your changes!
```

## How It Works

### 1. Import System Tracks ROM Addresses

When sprites are extracted, their metadata includes:
```json
{
  "name": "enemy_18_skeleton",
  "rom_offset": "0x098600",
  "palette_offset": "0x048120",
  "size_bytes": 1152
}
```

### 2. Build Integration Rebuilds Graphics

```bash
python tools/build_integration.py --rebuild
```

This:
- Detects modified PNGs (SHA256 hash tracking)
- Converts PNG â†’ 4BPP/2BPP tiles
- Saves binary data to `data/rebuilt/`
- Creates import summary with ROM addresses
- **Automatically generates ASM includes**

### 3. ASM Generator Creates Include Files

```bash
python tools/generate_graphics_asm.py
```

This creates:
- `src/asm/graphics/enemies_auto.asm` - Enemy sprite includes
- `src/asm/graphics/characters_auto.asm` - Character sprite includes
- `src/asm/graphics/graphics_auto.asm` - Master include file

### 4. Master Include File

Generated at `src/asm/graphics/graphics_auto.asm`:

```asm
; Auto-generated master graphics include file
; Generated by tools/generate_graphics_asm.py
; This file includes all rebuilt graphics into the ROM

; DO NOT EDIT MANUALLY - This file is auto-generated
; Regenerate with: python tools/generate_graphics_asm.py

incsrc "src/asm/graphics/enemies_auto.asm"
incsrc "src/asm/graphics/characters_auto.asm"
```

### 5. Category Include Files

Example `src/asm/graphics/enemies_auto.asm`:

```asm
; Auto-generated sprite graphics includes
; Generated by tools/generate_graphics_asm.py

; Graphics at $098600
org $098600
	; enemy_18_skeleton - 1152 bytes
	incbin "data/rebuilt/sprites/enemies/enemy_18_skeleton.bin"

org $048120
	; enemy_18_skeleton palette - 16 bytes
	incbin "data/rebuilt/sprites/enemies/enemy_18_skeleton_palette.bin"

; Graphics at $098800
org $098800
	; enemy_19_skeleton - 1152 bytes
	incbin "data/rebuilt/sprites/enemies/enemy_19_skeleton.bin"

org $048130
	; enemy_19_skeleton palette - 16 bytes
	incbin "data/rebuilt/sprites/enemies/enemy_19_skeleton_palette.bin"
```

## Integration with Main ASM

Add this to your main assembly file (e.g., `src/asm/bank_00.asm` or `src/asm/ffmq.asm`):

```asm
; Include rebuilt graphics
incsrc "src/asm/graphics/graphics_auto.asm"
```

Or include specific categories:

```asm
; Include only enemy sprites
incsrc "src/asm/graphics/enemies_auto.asm"

; Include only character sprites
incsrc "src/asm/graphics/characters_auto.asm"
```

## Complete Workflow

### Using Make (Recommended)

```bash
# 1. Extract graphics (first time only)
make graphics-extract

# 2. Edit PNGs in your favorite editor
# (Edit files in data/extracted/sprites/enemies/)

# 3. Rebuild and build ROM
make rom-with-graphics
```

That's it! The `rom-with-graphics` target automatically:
- Rebuilds modified graphics
- Generates ASM includes
- Builds ROM with asar

### Using Python Directly

```bash
# 1. Extract (first time only)
python tools/build_integration.py --extract

# 2. Edit PNGs
# ...

# 3. Rebuild graphics
python tools/build_integration.py --rebuild

# 4. Build ROM
asar src/asm/main.asm build/ffmq-modified.sfc
```

### Step-by-Step Example

1. **Edit the skeleton enemy sprite:**
   ```bash
   # Open in your image editor
   open data/extracted/sprites/enemies/enemy_18_skeleton.png
   
   # Make changes, save (preserve dimensions and palette!)
   ```

2. **Rebuild graphics:**
   ```bash
   python tools/build_integration.py --rebuild
   ```
   
   Output:
   ```
   ğŸ”¨ Rebuilding modified graphics...
     Found 1 modified files:
       â€¢ data/extracted/sprites/enemies/enemy_18_skeleton.png
   
     ğŸ“¦ Importing sprites...
       âœ“ Imported 1 files
   
     ğŸ”¨ Generating ASM includes...
       ğŸ“ Generating ASM for enemies...
         âœ“ Generated 83 sprite includes
         ğŸ“„ src/asm/graphics/enemies_auto.asm
   
   âœ… Graphics rebuild complete!
   ```

3. **Build ROM:**
   ```bash
   make rom
   ```
   
   Your modified skeleton sprite is now in the ROM!

## Makefile Targets

### Graphics Pipeline Targets

| Target | Description |
|--------|-------------|
| `make graphics-extract` | Extract all graphics from ROM to PNG |
| `make graphics-rebuild` | Rebuild only modified graphics (incremental) |
| `make graphics-full` | Full rebuild (extract + rebuild) |
| `make graphics-validate` | Validate all graphics |
| `make graphics-asm` | Generate ASM includes only |
| `make graphics-pipeline` | Complete workflow (rebuild + generate ASM) |
| `make rom-with-graphics` | Build ROM with integrated graphics |

### Quick Reference

```bash
# First time setup
make graphics-extract

# Edit PNGs, then rebuild
make graphics-rebuild

# Build ROM with your changes
make rom-with-graphics

# Validate everything
make graphics-validate
```

## Address Management

### Address Validation

The system validates that addresses don't overlap:

```bash
python tools/generate_graphics_asm.py --validate
```

Output:
```
ğŸ” Validating ROM addresses...
  âœ“ All 83 address ranges valid (no overlaps)
```

If overlaps are detected:
```
âŒ Found 2 address overlaps:
   enemy_18_skeleton ($098600-$098D80)
   overlaps with
   enemy_19_skeleton ($098700-$098E80)
```

### Address Ranges by Bank

The system organizes graphics by SNES banks:

- **Bank $04** ($048000-$04FFFF): Graphics tiles (32KB)
- **Bank $05** ($058000-$05FFFF): Palettes (32KB)
- **Bank $09** ($098000-$09FFFF): Enemy sprites + palettes (32KB)

## File Structure

```
data/
â”œâ”€â”€ extracted/              # Source PNGs (edit these!)
â”‚   â””â”€â”€ sprites/
â”‚       â””â”€â”€ enemies/
â”‚           â”œâ”€â”€ enemy_18_skeleton.png
â”‚           â””â”€â”€ enemy_18_skeleton_meta.json
â”‚
â”œâ”€â”€ rebuilt/                # Binary output
â”‚   â””â”€â”€ sprites/
â”‚       â””â”€â”€ enemies/
â”‚           â”œâ”€â”€ enemy_18_skeleton.bin
â”‚           â”œâ”€â”€ enemy_18_skeleton_palette.bin
â”‚           â””â”€â”€ import_summary.json
â”‚
src/asm/graphics/           # Auto-generated ASM
â”œâ”€â”€ enemies_auto.asm
â”œâ”€â”€ characters_auto.asm
â””â”€â”€ graphics_auto.asm

build/
â””â”€â”€ graphics_manifest.json  # Build tracking (SHA256 hashes)
```

## Advanced Usage

### Generating ASM for Specific Category

```bash
python tools/generate_graphics_asm.py --category enemies
```

### Manual ASM Generation

```bash
python tools/generate_graphics_asm.py
```

### Incremental Builds

The system only rebuilds **changed** graphics:

```bash
# First build
make graphics-rebuild
# â†’ Rebuilds 83 sprites (~5 seconds)

# Edit one sprite
# (Edit enemy_18_skeleton.png)

# Rebuild
make graphics-rebuild
# â†’ Rebuilds 1 sprite (~0.1 seconds)
```

Hash tracking in `build/graphics_manifest.json`:
```json
{
  "version": "1.0",
  "last_build": "2025-11-02T02:15:00",
  "files": {
    "data/extracted/sprites/enemies/enemy_18_skeleton.png": {
      "hash": "a7f3b2c1d4e5f6g7...",
      "last_modified": "2025-11-02T02:10:00"
    }
  }
}
```

## Integration with CI/CD

### GitHub Actions Example

```yaml
name: Build ROM
on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Install dependencies
        run: |
          sudo apt-get install asar python3
          pip3 install pillow
      
      - name: Rebuild graphics
        run: make graphics-rebuild
      
      - name: Build ROM
        run: make rom
      
      - name: Upload ROM
        uses: actions/upload-artifact@v2
        with:
          name: ffmq-modified.sfc
          path: build/ffmq-modified.sfc
```

## Troubleshooting

### "No import summary found"

**Problem:** `import_summary.json` is missing.

**Solution:**
```bash
# Re-import graphics
python tools/import/import_sprites.py \
  data/extracted/sprites/enemies/ \
  data/rebuilt/sprites/enemies/
```

### "Address overlap detected"

**Problem:** Two graphics trying to use the same ROM space.

**Solution:** Check metadata files for duplicate `rom_offset` values.

### "ASM generation failed"

**Problem:** Metadata is invalid or missing.

**Solution:**
```bash
# Validate all graphics
make graphics-validate
```

### "ROM build failed"

**Problem:** Asar can't find include files.

**Solution:** Regenerate ASM:
```bash
make graphics-asm
```

## Performance

### Build Times

| Operation | Time (83 sprites) | Time (1 sprite) |
|-----------|------------------|-----------------|
| Extract | ~3 seconds | - |
| Rebuild | ~5 seconds | ~0.1 seconds |
| Generate ASM | ~0.5 seconds | ~0.5 seconds |
| Build ROM | ~2 seconds | ~2 seconds |
| **Total** | **~10 seconds** | **~2.5 seconds** |

### Optimization Tips

1. **Use incremental builds** - Only modified files are rebuilt
2. **Validate before building** - Catch errors early
3. **Group changes** - Edit multiple sprites before rebuilding
4. **Use Makefile targets** - Automates the entire workflow

## Technical Details

### Asar `org` Directive

The generated ASM uses `org` (origin) to set ROM addresses:

```asm
org $098600              ; Set ROM write position
incbin "file.bin"        ; Write binary data at this position
```

This overwrites the original ROM data at that address with your edited graphics.

### Asar `incbin` Directive

The `incbin` directive includes binary files directly:

```asm
incbin "data/rebuilt/sprites/enemies/enemy_18_skeleton.bin"
```

Asar reads the .bin file and writes its bytes to the ROM.

### Address Calculation

ROM addresses are calculated from metadata:

```
Bank $09, offset $8600
â†’ LoROM address = $098600
â†’ File offset = (Bank Ã— $8000) + (ROM_addr - $8000)
â†’ File offset = ($09 Ã— $8000) + ($8600 - $8000)
â†’ File offset = $48000 + $600 = $48600
```

## Future Enhancements

- [ ] Auto-compress graphics (reduce ROM space)
- [ ] Sprite preview in build output
- [ ] ROM comparison tool (original vs modified)
- [ ] Batch operations on multiple categories
- [ ] Visual ROM map showing used/free space
- [ ] Integration with level editors

## References

- [Asar Documentation](https://github.com/RPGHacker/asar)
- [SNES LoROM Memory Map](https://snes.nesdev.org/wiki/Memory_map)
- [FFMQ ROM Structure](docs/ROM_PIPELINE_PLAN.md)
- [Build Integration Guide](docs/BUILD_INTEGRATION.md)

---

**Author:** FFMQ Disassembly Project  
**Date:** 2025-11-02  
**Version:** 3.0 - Asar Integration Complete
